window.AudioContext=window.AudioContext||window.webkitAudioContext;if(!AudioContext)throw alert("Sorry, your browser doesn't support the Web Audio APIs."),Error("Sorry, your browser doesn't support the Web Audio APIs. Execution Aborted.");var context=new AudioContext,nodes={};nodes.touchOSC=context.createOscillator();nodes.touchOSCvolume=context.createGain();nodes.filter=context.createBiquadFilter();nodes.delay=context.createDelay();nodes.feedback=context.createGain();nodes.volume=context.createGain();
nodes.analyser=context.createAnalyser();nodes.script=context.createScriptProcessor(2048,1,1);nodes.touchOSC.type=waveSelect.value;nodes.touchOSC.frequency.value=0;nodes.touchOSC.detune.value=0;nodes.touchOSCvolume.gain.value=1;nodes.filter.type=filterSelect.value;nodes.filter.frequency.value=context.sampleRate/2;nodes.filter.Q.value=0;nodes.filter.gain.value=0;nodes.delay.delayTime.value=0;nodes.feedback.gain.value=0;nodes.volume.gain.value=0.5;nodes.analyser.smoothingTimeConstant=0.3;
nodes.analyser.fftSize=1024;nodes.touchOSC.connect(nodes.touchOSCvolume);nodes.touchOSCvolume.connect(nodes.filter);nodes.filter.connect(nodes.volume);nodes.filter.connect(nodes.delay);nodes.delay.connect(nodes.feedback);nodes.feedback.connect(nodes.delay);nodes.feedback.connect(nodes.volume);nodes.volume.connect(context.destination);nodes.volume.connect(nodes.analyser);nodes.analyser.connect(nodes.script);nodes.script.connect(context.destination);
nodes.script.onaudioprocess=function(){var a=new Uint8Array(nodes.analyser.frequencyBinCount);nodes.analyser.getByteFrequencyData(a);drawSpectrum(a)};function oscFrequencyChange(a){a=1*a.x/util.docWidth;var c=Math.log(4186.01/27.5)/Math.LN2;a=Math.pow(2,c*(a-1));nodes.touchOSC.frequency.value=4186.01*a}function vcfFrequencyChange(a){var c=context.sampleRate/2;a=1-1*a.y/util.docHeight;var b=Math.log(c/27.5)/Math.LN2;a=Math.pow(2,b*(a-1));nodes.filter.frequency.value=c*a}
function touch(a){try{nodes.touchOSC.start(0)}catch(c){}nodes.touchOSCvolume.gain.value=1;oscFrequencyChange(a);vcfFrequencyChange(a);pad.addEventListener("pointermove",touch);a.preventDefault();return!1}var pad=document.querySelector("svg");pad.addEventListener("pointerdown",touch);pad.addEventListener("pointerup",function(){pad.removeEventListener("pointermove",touch);nodes.touchOSCvolume.gain.value=0});
var keyboard=qwertyHancock({id:"keyboard",width:util.docWidth,height:util.docHeigth/2,octaves:2,startNote:"C4",whiteNotesColour:"white",blackNotesColour:"black",hoverColour:"#f3e939",keyboardLayout:"en"}),keyNodes=[];keyboard.keyDown(function(a,c){var b=context.createOscillator();b.type=waveSelect.value;b.frequency.value=c;b.detune.value=oscDetuneRange.value;b.connect(nodes.filter);try{b.start(0)}catch(d){}keyNodes.push(b)});
keyboard.keyUp(function(a,c){for(var b=0;b<keyNodes.length;b++)Math.round(keyNodes[b].frequency.value)===Math.round(c)&&(keyNodes[b].stop(0),keyNodes[b].disconnect(),keyNodes.splice(b,1))});
